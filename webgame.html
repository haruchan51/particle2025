<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éñ„É≠„ÉÉ„ÇØ„Éª„Éñ„É©„Çπ„Éà„Éª„Ç¢„Çø„ÉÉ„ÇØ</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #202020;
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            color: white;
        }
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            border: 10px solid #FF69B4;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
        }
        canvas {
            display: block;
            background: #111111;
        }

        /* --- UI „Çπ„Çø„Ç§„É´ --- */
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        /* „Ç≤„Éº„É†‰∏≠UI */
        #game-info {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #FF69B4;
            z-index: 10;
            display: flex;
            gap: 30px;
        }
        
        /* „Éõ„Éº„É†ÁîªÈù¢/„É©„É≥„Ç≠„É≥„Ç∞ */
        #home-screen, #rank-screen {
            display: none;
            text-align: center;
        }
        .title {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 40px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        .menu-button {
            padding: 15px 30px;
            margin: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #202020;
            background-color: #00FFFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px #00BFFF;
            transition: all 0.1s;
        }
        .menu-button:hover {
            background-color: #00BFFF;
        }
        .menu-button:active {
            box-shadow: 0 1px #00BFFF;
            transform: translateY(3px);
        }

        /* „É©„É≥„Ç≠„É≥„Ç∞Ë°® */
        #ranking-list {
            list-style: none;
            padding: 0;
            width: 80%;
            max-width: 400px;
            margin-top: 20px;
            text-align: left;
        }
        #ranking-list li {
            background-color: #333;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
        }
        #ranking-list li:first-child {
            background-color: #FFD700;
            color: #202020;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="game-info" style="display: none;">
        <div>„Çπ„Ç≥„Ç¢: <span id="score">0</span></div>
        <div class="stage-label">„Çπ„ÉÜ„Éº„Ç∏: <span id="stage-num">1</span>/3</div>
        <div class="time-label">ÊôÇÈñì: <span id="time-display">0.00</span>Áßí</div>
    </div>

    <canvas id="blockBlastCanvas"></canvas>

    <div id="ui-overlay">
        <div id="home-screen">
            <div class="title">üß± „Éñ„É≠„ÉÉ„ÇØ„Éª„Éñ„É©„Çπ„Éà„Éª„Ç¢„Çø„ÉÉ„ÇØ üí•</div>
            <button class="menu-button" id="start-button">„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
            <button class="menu-button" id="rank-button">„É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã</button>
        </div>

        <div id="rank-screen">
            <div class="title" style="font-size: 36px;">üèÜ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ„É©„É≥„Ç≠„É≥„Ç∞ üèÜ</div>
            <ol id="ranking-list"></ol>
            <button class="menu-button" id="back-button">„Éõ„Éº„É†„Å´Êàª„Çã</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('blockBlastCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const stageNumElement = document.getElementById('stage-num');
        const timeDisplayElement = document.getElementById('time-display');
        const uiOverlay = document.getElementById('ui-overlay');
        const gameInfo = document.getElementById('game-info');
        const homeScreen = document.getElementById('home-screen');
        const rankScreen = document.getElementById('rank-screen');
        const rankingList = document.getElementById('ranking-list');
        
        // --- „Ç≤„Éº„É†„ÅÆÂÆöÊï∞ ---
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        const BALL_RADIUS = 10;
        
        // Áâ©ÁêÜÊºîÁÆó
        const CONTROL_FORCE = 0.5;
        const INITIAL_VELOCITY_Y = -15; 
        const LAUNCH_INTERVAL = 100; 

        // „Éñ„É≠„ÉÉ„ÇØË®≠ÂÆö
        const BLOCK_ROWS = 10;
        const BLOCK_COLS = 16;
        const BLOCK_WIDTH = CANVAS_WIDTH / BLOCK_COLS;
        const BLOCK_HEIGHT = 20;
        const BLOCK_START_Y = 50; 
        
        // „Ç≤„Éº„É†„ÅÆÁä∂ÊÖã
        let score = 0;
        let gameState = 'HOME';
        let blocks = [];
        let balls = [];
        let launchTimer;
        
        let currentStage = 1;
        let gameStartTime = 0;
        let stageClearTimes = {};
        let keys = { ArrowLeft: false, ArrowRight: false };

        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;

        // --- „Éñ„É≠„ÉÉ„ÇØ„ÅÆ„ÇØ„É©„Çπ ---
        class Block {
            constructor(x, y, color, health) {
                this.x = x; 
                this.y = y; 
                this.width = BLOCK_WIDTH;
                this.height = BLOCK_HEIGHT; 
                this.color = color; // „Éô„Éº„Çπ„Ç´„É©„Éº (Êú™‰ΩøÁî®„Å†„ÅåÊÆã„Åô)
                this.health = health;
                this.maxHealth = health;
            }
            draw() {
                // HP„Å´Âü∫„Å•„ÅèËâ≤„ÅÆÂ§âÂåñÔºàÂâä„Çâ„Çå„Å¶„ÅÑ„ÅèË°®ÁèæÔºâ
                // üö® ‰øÆÊ≠£: HP„Å´Âêà„Çè„Åõ„Å¶„Éñ„É≠„ÉÉ„ÇØ„ÅÆËâ≤„ÇíÊøÉ„Åè/ËñÑ„ÅèÂ§âÂåñ„Åï„Åõ„Çã
                let intensity = this.health / this.maxHealth;
                let r = Math.floor(255 * intensity);
                let g = Math.floor(150 * intensity);
                let b = Math.floor(150 * intensity);

                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#222'; 
                ctx.lineWidth = 1;
                ctx.strokeRect(this.x, this.y, this.width, this.height);

                // HP„ÅÆÊï∞ÂÄ§„ÇíÊèèÁîª
                ctx.fillStyle = this.health > 5 ? '#FFF' : '#000'; // HP„ÅåÈ´ò„ÅÑ„Å®ÁôΩÊñáÂ≠ó
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.health, this.x + this.width / 2, this.y + this.height / 2);
            }
        }
        
        // --- „Éú„Éº„É´„ÅÆ„ÇØ„É©„Çπ ---
        class Ball {
            constructor(startX, startY, initialVY) {
                this.x = startX;
                this.y = startY;
                this.radius = BALL_RADIUS;
                this.color = '#00FFFF';
                this.vx = 0;
                this.vy = initialVY;
                this.isLaunched = true;
                this.isControlled = false;
            }
            
            applyForces() {
                if (this.isControlled) {
                    if (keys.ArrowLeft)  this.vx -= CONTROL_FORCE;
                    if (keys.ArrowRight) this.vx += CONTROL_FORCE;
                }
                
                const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                const MAX_SPEED = 15;
                if (currentSpeed > MAX_SPEED) {
                    this.vx = (this.vx / currentSpeed) * MAX_SPEED;
                    this.vy = (this.vy / currentSpeed) * MAX_SPEED;
                }
            }

            update() {
                if (!this.isLaunched) return;
                this.applyForces();
                this.x += this.vx;
                this.y += this.vy;
                
                // ÁîªÈù¢Á´Ø„Åß„ÅÆÂèçÂ∞Ñ
                if (this.x - this.radius < 0 || this.x + this.radius > CANVAS_WIDTH) {
                    this.vx *= -1;
                    this.x = Math.max(this.radius, Math.min(this.x, CANVAS_WIDTH - this.radius));
                }
                if (this.y - this.radius < 0) {
                    this.vy *= -1;
                    this.y = this.radius;
                }
                
                // ÁîªÈù¢‰∏ãÁ´Ø („Éü„Çπ)
                if (this.y + this.radius > CANVAS_HEIGHT) {
                    this.isLaunched = false;
                }
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // --- „Çπ„ÉÜ„Éº„Ç∏„É¨„Ç§„Ç¢„Ç¶„Éà„Å®Èõ£ÊòìÂ∫¶Ë™øÊï¥ ---
        function initializeBlocks(stage) {
            blocks = [];
            let blockHealth;
            const HP_BASE = stage * 3; // üö® Èõ£ÊòìÂ∫¶Ë™øÊï¥: „Çπ„ÉÜ„Éº„Ç∏„Å´Âøú„Åò„Å¶HP„ÅÆÂü∫Êú¨ÂÄ§„ÇíÈ´ò„Åè„Åô„Çã
            const DENSITY_FACTOR = (stage === 3) ? 1.0 : 0.8; // „Çπ„ÉÜ„Éº„Ç∏3„ÅØ„Éñ„É≠„ÉÉ„ÇØÂØÜÂ∫¶100%

            for (let r = 0; r < BLOCK_ROWS; r++) {
                for (let c = 0; c < BLOCK_COLS; c++) {
                    // üö® Èõ£ÊòìÂ∫¶Ë™øÊï¥: „Çπ„ÉÜ„Éº„Ç∏„Åî„Å®„Å´HP„Å®ÈÖçÁΩÆ„ÇíË™øÊï¥
                    if (Math.random() < DENSITY_FACTOR) { 
                        // „É©„É≥„ÉÄ„É†„Å´HP„ÇíË®≠ÂÆö (HP„Éô„Éº„Çπ + 0ÔΩû3)
                        blockHealth = HP_BASE + Math.floor(Math.random() * 3) + 1;
                        
                        const blockX = c * BLOCK_WIDTH;
                        const blockY = r * BLOCK_HEIGHT + BLOCK_START_Y;
                        
                        blocks.push(new Block(blockX, blockY, '#FFF', blockHealth));
                    }
                }
            }
        }
        
        function checkCollisions() {
            // üö® ‰øÆÊ≠£: ÁîªÈù¢Â§ñ„Å´Âá∫„ÅüÁéâ„ÅØ„Åì„Åì„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ (Âæå„ÅÆÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØ„Å®ÈÄ£Êê∫)
            balls = balls.filter(ball => ball.isLaunched);

            balls.forEach(ball => {
                if (ball.y < LAUNCH_POS_Y - 5) {
                    ball.isControlled = true;
                }
                
                for (let i = blocks.length - 1; i >= 0; i--) {
                    const block = blocks[i];

                    const closestX = Math.max(block.x, Math.min(ball.x, block.x + block.width));
                    const closestY = Math.max(block.y, Math.min(ball.y, block.y + block.height));
                    
                    const distanceX = ball.x - closestX;
                    const distanceY = ball.y - closestY;
                    
                    if ((distanceX * distanceX + distanceY * distanceY) < (ball.radius * ball.radius)) {
                        
                        // ÈÄüÂ∫¶„ÅÆÂèçËª¢
                        const penetrationDepthX = ball.radius - Math.abs(distanceX);
                        const penetrationDepthY = ball.radius - Math.abs(distanceY);

                        if (penetrationDepthX > penetrationDepthY) {
                            ball.vy *= -1;
                        } else {
                            ball.vx *= -1;
                        }
                        
                        // HP„ÇíÂâä„Çã
                        block.health--;
                        score += 10;
                        scoreElement.textContent = score;

                        // „Éñ„É≠„ÉÉ„ÇØÁ†¥Â£ä
                        if (block.health <= 0) {
                            blocks.splice(i, 1);
                        }
                        
                        // „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢Âà§ÂÆö
                        if (blocks.length === 0) {
                            stageClearTimes[currentStage] = (Date.now() - gameStartTime) / 1000;
                            
                            if (currentStage < 3) {
                                currentStage++;
                                balls = [];
                                // üö® ‰øÆÊ≠£: „Çπ„ÉÜ„Éº„Ç∏„ÅåÂ§â„Çè„Çã„Å®„Åç„Å´Êñ∞„Åó„ÅÑ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂàùÊúüÂåñ
                                initializeBlocks(currentStage); 
                                stageNumElement.textContent = `${currentStage}/3`;
                            } else {
                                endGame(true);
                                return;
                            }
                        }
                        
                        break; 
                    }
                }
            });
        }
        
        function launchBall() {
            if (gameState !== 'PLAYING') return;
            
            if (balls.filter(b => b.isLaunched).length < 10) { 
                const newBall = new Ball(LAUNCH_POS_X, LAUNCH_POS_Y, INITIAL_VELOCITY_Y);
                balls.push(newBall);
            }
        }


        // --- UI / „É©„É≥„Ç≠„É≥„Ç∞Âá¶ÁêÜ ---

        const RANKING_KEY = 'BlockBlastRanking';

        function loadRanking() {
            const json = localStorage.getItem(RANKING_KEY);
            return json ? JSON.parse(json) : [];
        }

        function saveRanking(totalTime) {
            let rankings = loadRanking();
            rankings.push(totalTime);
            rankings.sort((a, b) => a - b); 
            rankings = rankings.slice(0, 10);
            localStorage.setItem(RANKING_KEY, JSON.stringify(rankings));
        }

        function displayRanking() {
            const rankings = loadRanking();
            rankingList.innerHTML = '';
            
            if (rankings.length === 0) {
                rankingList.innerHTML = '<li>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</li>';
                return;
            }

            rankings.forEach((time, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${index + 1}.</span> <span>${time.toFixed(2)}Áßí</span>`;
                rankingList.appendChild(li);
            });
        }

        function setScreen(screen) {
            uiOverlay.style.display = 'flex';
            homeScreen.style.display = 'none';
            rankScreen.style.display = 'none';
            gameInfo.style.display = 'none';
            gameState = screen;

            if (screen === 'HOME') {
                homeScreen.style.display = 'block';
            } else if (screen === 'RANKING') {
                rankScreen.style.display = 'block';
                displayRanking();
            } else if (screen === 'PLAYING') {
                uiOverlay.style.display = 'none';
                gameInfo.style.display = 'flex';
            }
        }

        // --- „Ç≤„Éº„É†„É´„Éº„Éó„Å®Âà∂Âæ° ---
        let animationFrameId = null;

        function animate() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            if (gameState === 'PLAYING') {
                const elapsed = Date.now() - gameStartTime;
                timeDisplayElement.textContent = (elapsed / 1000).toFixed(2);
                
                // Áô∫Â∞ÑÂè∞„ÅÆÊèèÁîª
                ctx.fillStyle = '#9370DB'; 
                ctx.beginPath();
                ctx.arc(LAUNCH_POS_X, LAUNCH_POS_Y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // üö® „Éñ„É≠„ÉÉ„ÇØ„Å®Áéâ„ÅÆÊèèÁîª
                blocks.forEach(block => block.draw());
                balls.forEach(ball => {
                    // isLaunched„Ååtrue„ÅÆÁéâ„ÅÆ„ÅøÊõ¥Êñ∞„Å®ÊèèÁîª„ÇíË°å„ÅÜ
                    if(ball.isLaunched) { 
                        ball.update();
                        ball.draw();
                    }
                });
                checkCollisions();
            }

            animationFrameId = requestAnimationFrame(animate);
        }
        
        function startGame() {
            if (gameState === 'PLAYING') return;
            score = 0;
            currentStage = 1;
            stageClearTimes = {};
            
            setScreen('PLAYING');

            gameStartTime = Date.now(); 
            stageNumElement.textContent = `${currentStage}/3`;
            timeDisplayElement.textContent = '0.00';

            // üö® ‰øÆÊ≠£: „Çπ„ÉÜ„Éº„Ç∏1„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂàùÊúüÂåñ
            initializeBlocks(currentStage); 
            balls = [];
            scoreElement.textContent = score;
            
            clearInterval(launchTimer);
            launchTimer = setInterval(launchBall, LAUNCH_INTERVAL); 

            if (!animationFrameId) {
                animate();
            }
        }
        
        function endGame(win = false) {
            clearInterval(launchTimer);
            
            if (win) {
                let totalTime = 0;
                for (let i = 1; i <= 3; i++) {
                    totalTime += stageClearTimes[i] || 0;
                }
                
                saveRanking(totalTime);
                alert(`üöÄ ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅÂêàË®à„Çø„Ç§„É†: ${totalTime.toFixed(2)}Áßí„Åß„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤„Åï„Çå„Åæ„Åó„ÅüÔºÅ`);
            } else {
                alert(`„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº... „Çπ„Ç≥„Ç¢: ${score}ÁÇπ`);
            }
            
            setScreen('HOME');
        }

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        document.getElementById('start-button').addEventListener('click', startGame);
        document.getElementById('rank-button').addEventListener('click', () => setScreen('RANKING'));
        document.getElementById('back-button').addEventListener('click', () => setScreen('HOME'));
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && gameState === 'HOME') {
                startGame();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                if (gameState === 'PLAYING') keys[e.code] = true;
                e.preventDefault(); 
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                if (gameState === 'PLAYING') keys[e.code] = false;
            }
        });

        setScreen('HOME');
        animate(); 
    });
</script>
</body>
</html>
