<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ­ãƒƒã‚¯ãƒ»ãƒ–ãƒ©ã‚¹ãƒˆãƒ»ã‚¢ã‚¿ãƒƒã‚¯ (æœ€çµ‚ç‰ˆ)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #202020;
            font-family: 'Montserrat', sans-serif; 
            color: white;
        }
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            border: 10px solid #FF00AA; 
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 0, 170, 0.8); 
        }
        canvas {
            display: block;
            background: #0A0A0A; 
        }

        /* --- UI ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; 
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        #game-info {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #39FF14; 
            z-index: 10;
            display: flex; 
            gap: 30px;
            align-items: center;
            border: 1px solid #39FF14;
        }
        
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .title {
            font-size: 60px; 
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700; 
            margin-bottom: 40px;
        }
        .menu-button {
            padding: 15px 40px;
            margin: 15px;
            font-size: 26px;
            font-weight: bold;
            color: #0A0A0A;
            background-color: #00FFFF; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 15px #00FFFF, 0 4px #00BFFF;
            transition: all 0.1s;
        }
        .menu-button:hover {
             background-color: #00BFFF;
             transform: translateY(-2px);
             box-shadow: 0 0 20px #00FFFF, 0 6px #00BFFF;
        }
        #ranking-list, #home-ranking-list {
            list-style: none;
            padding: 0;
            width: 80%;
            max-width: 450px;
            margin-top: 20px;
            text-align: left;
        }
        #ranking-list li, #home-ranking-list li {
            background-color: rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 6px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            border-left: 5px solid #FF00AA;
        }
        #home-screen h3 {
            margin-top: 50px;
            color: #FF00AA;
            text-shadow: 0 0 5px #FF00AA;
            font-size: 24px;
        }

        /* ã‚¯ã‚¤ã‚ºç”»é¢ */
        #quiz-screen {
            display: none;
            text-align: center;
            width: 70%;
            background: #1A1A1A;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
            border: 2px solid #39FF14;
        }
        #quiz-question {
            font-size: 24px;
            margin-bottom: 20px;
            color: #FF00AA;
            text-shadow: 0 0 5px #FF00AA;
        }
        .quiz-option {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 18px;
            font-weight: bold;
            color: #0A0A0A;
            background-color: #00FFFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .result-text.correct {
            color: #39FF14;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 10px #39FF14;
        }
        .result-text.incorrect {
            color: #FF3131;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 10px #FF3131;
        }

        /* ãƒ›ãƒ¼ãƒ /çµ‚äº†ç”»é¢ */
        #home-screen, #end-screen {
             text-align: center;
             display: none;
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="game-info">
        <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
        <div class="stage-label">ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="stage-num">1</span>/3</div>
        <div class="time-label">æ™‚é–“: <span id="time-display">0.00</span>ç§’</div>
        <button id="home-button" class="menu-button" style="padding: 5px 10px; font-size: 16px; margin: 0; background-color: #FFD700; color: #202020; box-shadow: 0 0 10px #FFD700, 0 4px #FFA500;">ãƒ›ãƒ¼ãƒ ã¸</button>
    </div>

    <canvas id="blockBlastCanvas"></canvas>

    <div id="ui-overlay">
        <div id="home-screen">
            <div class="title">BLOCK BLAST ATTACK</div>
            <button class="menu-button" id="start-game-button">START GAME</button>
            <h3>ğŸ† CLEARED TIME RANKING ğŸ†</h3>
            <ol id="home-ranking-list"></ol>
        </div>

        <div id="quiz-screen">
            <h2>ã‚¹ãƒ†ãƒ¼ã‚¸ <span id="quiz-stage-num">1</span> ã‚¯ã‚¤ã‚ºãƒãƒ£ãƒ¬ãƒ³ã‚¸!</h2>
            <p id="quiz-question"></p>
            <div id="quiz-options"></div>
            <p id="quiz-result-message" class="result-text"></p>
            <button id="continue-button" class="menu-button" style="display: none; background-color: #FF00AA; color: white; box-shadow: 0 0 15px #FF00AA, 0 4px #D0008D;">ã‚²ãƒ¼ãƒ å†é–‹</button>
        </div>

        <div id="end-screen">
             <div class="title" id="end-title"></div>
             <h3>ã‚ãªãŸã®è¨˜éŒ²</h3>
             <ol id="ranking-list"></ol>
             <button class="menu-button" id="restart-button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('blockBlastCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const stageNumElement = document.getElementById('stage-num');
        const timeDisplayElement = document.getElementById('time-display');
        const uiOverlay = document.getElementById('ui-overlay');
        
        // --- UIè¦ç´  ---
        const homeScreen = document.getElementById('home-screen');
        const startGameButton = document.getElementById('start-game-button');
        const homeRankingList = document.getElementById('home-ranking-list');
        const endScreen = document.getElementById('end-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const quizStageNumElement = document.getElementById('quiz-stage-num');
        const quizQuestionElement = document.getElementById('quiz-question');
        const quizOptionsElement = document.getElementById('quiz-options');
        const quizResultMessageElement = document.getElementById('quiz-result-message');
        const continueButton = document.getElementById('continue-button');
        const endTitle = document.getElementById('end-title');
        const rankingList = document.getElementById('ranking-list');
        const homeButton = document.getElementById('home-button');
        
        // --- ã‚²ãƒ¼ãƒ ã®å®šæ•° ---
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        const BALL_RADIUS = 10;
        // const CONTROL_FORCE = 0.5; // ãƒ‘ãƒ‰ãƒ«æ“ä½œã«æˆ»ã‚‹ãŸã‚ä¸è¦
        const PADDLE_SPEED = 10; // ğŸš€ è¿½åŠ : ãƒ‘ãƒ‰ãƒ«ã®ç§»å‹•é€Ÿåº¦
        let INITIAL_VELOCITY_Y = -15; 
        const LAUNCH_INTERVAL = 100; 
        const DEFAULT_PADDLE_WIDTH = 40;
        
        // ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š
        const BLOCK_ROWS = 10;
        const BLOCK_COLS = 16;
        const BLOCK_WIDTH = CANVAS_WIDTH / BLOCK_COLS;
        const BLOCK_HEIGHT = 20;
        const BLOCK_START_Y = 50; 
        const LAUNCH_POS_Y = CANVAS_HEIGHT - 50; 
        
        // --- ãƒ‘ãƒ‰ãƒ«ã®çŠ¶æ…‹ ---
        let paddleX = CANVAS_WIDTH / 2; // ç™ºå°„å°ã®ä¸­å¿ƒXåº§æ¨™
        let currentPaddleWidth = DEFAULT_PADDLE_WIDTH; 
        
        // --- ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ ---
        let score = 0;
        let gameState = 'HOME'; 
        let blocks = [];
        let balls = [];
        let launchTimer;
        
        let currentStage = 1;
        let gameStartTime = 0;
        let stageClearTimes = {};
        let keys = { ArrowLeft: false, ArrowRight: false }; // å·¦å³ã‚­ãƒ¼ã§ãƒ‘ãƒ‰ãƒ«ã‚’æ“ä½œã™ã‚‹

        // --- ç‰¹å…¸ç®¡ç† ---
        let ballSpeedMultiplier = 1.0; 
        let isPenetrating = false; 

        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;

        // --- ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ (å¤‰æ›´ãªã—) ---
        const QUIZ_DATA = [
            {
                question: "2024å¹´10æœˆã«ãƒãƒ¼ãƒ™ãƒ«åŒ–å­¦è³ã‚’å—è³ã—ãŸæ—¥æœ¬äººç§‘å­¦è€…ã®åå‰ã¯ï¼Ÿ",
                options: ["å±±ä¸­ ä¼¸å¼¥", "æœ¬åº¶ ä½‘", "é‡ä¾ è‰¯æ²»", "è—¤äº• å­ç”·"],
                answer: "è—¤äº• å­ç”·"
            },
            {
                question: "æ—¥æœ¬ã®ä¼çµ±çš„ãªæ–‡åŒ–ã§ã€å®¤ç”ºæ™‚ä»£ã«èŒ¶ã®æ¹¯ã¨ã—ã¦å¤§æˆã—ãŸã‚‚ã®ã¯ï¼Ÿ",
                options: ["è¯é“", "æ›¸é“", "èŒ¶é“", "èƒ½æ¥½"],
                answer: "èŒ¶é“"
            },
            {
                question: "åŒ—æµ·é“ã®çœŒåºæ‰€åœ¨åœ°ã§ã‚ã‚Šã€2024å¹´ã«å†¬å­£ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯æ‹›è‡´ã‚’æ–­å¿µã—ãŸéƒ½å¸‚ã¯ï¼Ÿ",
                options: ["æ—­å·å¸‚", "æœ­å¹Œå¸‚", "å‡½é¤¨å¸‚", "å¸¯åºƒå¸‚"],
                answer: "æœ­å¹Œå¸‚"
            },
            {
                question: "å¤ªé™½ç³»ã®æƒ‘æ˜Ÿã®ä¸­ã§ã€æœ€ã‚‚å¤šãã®è¡›æ˜Ÿï¼ˆæœˆï¼‰ã‚’æŒã¤ã¨ã•ã‚Œã‚‹æƒ‘æ˜Ÿã¯ï¼Ÿ",
                options: ["æœ¨æ˜Ÿ", "åœŸæ˜Ÿ", "å¤©ç‹æ˜Ÿ", "æµ·ç‹æ˜Ÿ"],
                answer: "åœŸæ˜Ÿ"
            },
            {
                question: "æ—¥æœ¬æœ€å¤ã®æ­Œé›†ã§ã‚ã‚Šã€ç´„4500é¦–ã®æ­ŒãŒåã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯ï¼Ÿ",
                options: ["å¤ä»Šå’Œæ­Œé›†", "æ–°å¤ä»Šå’Œæ­Œé›†", "ä¸‡è‘‰é›†", "ç«¹å–ç‰©èª"],
                answer: "ä¸‡è‘‰é›†"
            },
            {
                question: "ã€Œè³‡æœ¬è«–ã€ã®è‘—è€…ã§ã‚ã‚Šã€ç§‘å­¦çš„ç¤¾ä¼šä¸»ç¾©ã®å‰µå§‹è€…ã®ä¸€äººã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹æ€æƒ³å®¶ã¯ï¼Ÿ",
                options: ["ãƒãƒƒã‚¯ã‚¹ãƒ»ã‚¦ã‚§ãƒ¼ãƒãƒ¼", "ã‚¢ãƒ€ãƒ ãƒ»ã‚¹ãƒŸã‚¹", "ã‚«ãƒ¼ãƒ«ãƒ»ãƒãƒ«ã‚¯ã‚¹", "ã‚¸ãƒ§ãƒ³ãƒ»ãƒ­ãƒƒã‚¯"],
                answer: "ã‚«ãƒ¼ãƒ«ãƒ»ãƒãƒ«ã‚¯ã‚¹"
            }
        ];
        
        const USED_QUIZ_KEY = 'BlockBlastUsedQuizIndices';


        // --- ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¯ãƒ©ã‚¹ (å¤‰æ›´ãªã—) ---
        class Block {
            constructor(x, y, color, health) {
                this.x = x; 
                this.y = y; 
                this.width = BLOCK_WIDTH;
                this.height = BLOCK_HEIGHT; 
                this.health = health;
                this.maxHealth = health;
            }
            draw() {
                const damageRatio = 1 - (this.health / this.maxHealth); 
                let hue = (1 - damageRatio) * 120; 
                let saturation = 100;
                let lightness = 50 - (damageRatio * 20); 

                if (this.health <= 1) {
                    hue = 0; 
                    saturation = 100;
                    lightness = 40;
                } else if (this.health <= 3) {
                    hue = 30; 
                    saturation = 100;
                    lightness = 45;
                }
                
                ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#222'; 
                ctx.lineWidth = 1;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
            }
        }
        
        // --- ãƒœãƒ¼ãƒ«ã®ã‚¯ãƒ©ã‚¹ (åˆ¶å¾¡ç„¡åŠ¹åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯æ®‹ã™) ---
        class Ball {
            constructor(startX, startY, initialVY) {
                this.x = startX;
                this.y = startY;
                this.radius = BALL_RADIUS;
                this.color = '#00FFFF';
                this.vx = 0;
                this.vy = initialVY;
                this.isLaunched = true;
                this.isControlled = true; // ãƒœãƒ¼ãƒ«ãŒãƒ‘ãƒ‰ãƒ«ã«å½“ãŸã£ãŸå¾Œã«åˆ¶å¾¡ç„¡åŠ¹åŒ–ã™ã‚‹æ©Ÿèƒ½ã¯æ®‹ã™
            }
            
            applyForces() {
                // ğŸš€ ä¿®æ­£: ãƒœãƒ¼ãƒ«ã¸ã®å¾®èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰Šé™¤ï¼ˆãƒ‘ãƒ‰ãƒ«æ“ä½œã«æˆ»ã‚‹ãŸã‚ï¼‰
                
                const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                const MAX_SPEED = 15 * ballSpeedMultiplier; 
                if (currentSpeed > MAX_SPEED) {
                    this.vx = (this.vx / currentSpeed) * MAX_SPEED;
                    this.vy = (this.vy / currentSpeed) * MAX_SPEED;
                }
            }

            update() {
                if (!this.isLaunched) return;
                
                this.applyForces();
                this.x += this.vx;
                this.y += this.vy;
                
                // å£ã®åå°„
                if (this.x - this.radius < 0 || this.x + this.radius > CANVAS_WIDTH) {
                    this.vx *= -1;
                    this.x = Math.max(this.radius, Math.min(this.x, CANVAS_WIDTH - this.radius));
                }
                if (this.y - this.radius < 0) {
                    this.vy *= -1;
                    this.y = this.radius;
                }
                
                // ç”»é¢å¤–ã¸
                if (this.y + this.radius > CANVAS_HEIGHT) {
                    this.isLaunched = false;
                }
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
        function initializeBlocks(stage) {
            blocks = [];
            let blockHealth;
            const HP_BASE = stage * 3; 
            const DENSITY_FACTOR = (stage === 3) ? 1.0 : 0.8; 

            for (let r = 0; r < BLOCK_ROWS; r++) {
                for (let c = 0; c < BLOCK_COLS; c++) {
                    if (Math.random() < DENSITY_FACTOR) { 
                        blockHealth = HP_BASE + Math.floor(Math.random() * 3) + 1;
                        
                        const blockX = c * BLOCK_WIDTH;
                        const blockY = r * BLOCK_HEIGHT + BLOCK_START_Y;
                        
                        blocks.push(new Block(blockX, blockY, '#FFF', blockHealth));
                    }
                }
            }
        }
        
        // ğŸš€ ä¿®æ­£: ç™ºå°„å°ã®æ‰‹å‹•ç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯
        function updatePaddlePosition() {
            if (gameState !== 'PLAYING') return;

            if (keys.ArrowLeft) {
                paddleX -= PADDLE_SPEED;
            }
            if (keys.ArrowRight) {
                paddleX += PADDLE_SPEED;
            }
            
            // ç”»é¢å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            const minX = currentPaddleWidth;
            const maxX = CANVAS_WIDTH - currentPaddleWidth;
            
            paddleX = Math.max(minX, Math.min(paddleX, maxX));

            // ğŸš€ è¿½è¨˜: ç™ºå°„å°ãŒå‹•ã„ãŸã‚‰ã€ç™ºå°„å‰ã®ãƒœãƒ¼ãƒ«ã‚‚è¿½å¾“ã•ã›ã‚‹
            balls.forEach(ball => {
                if (ball.y > LAUNCH_POS_Y - 5) { // ç”»é¢ä¸‹éƒ¨ã«ã‚ã‚‹ãƒœãƒ¼ãƒ«ï¼ˆã¾ã ç™ºå°„ã•ã‚Œã¦ã„ãªã„ã¨ã¿ãªã™ï¼‰
                    ball.x = paddleX;
                }
            });
        }

        function checkCollisions() {
            balls = balls.filter(ball => ball.isLaunched);

            balls.forEach(ball => {
                
                // è¡çªãƒã‚§ãƒƒã‚¯ - ãƒ–ãƒ­ãƒƒã‚¯
                for (let i = blocks.length - 1; i >= 0; i--) {
                    const block = blocks[i];

                    const closestX = Math.max(block.x, Math.min(ball.x, block.x + block.width));
                    const closestY = Math.max(block.y, Math.min(ball.y, block.y + block.height));
                    
                    const distanceX = ball.x - closestX;
                    const distanceY = ball.y - closestY;
                    
                    if ((distanceX * distanceX + distanceY * distanceY) < (ball.radius * ball.radius)) {
                        
                        // æœ€åˆã®ãƒ–ãƒ­ãƒƒã‚¯ã«å½“ãŸã£ãŸç¬é–“ã€ãƒœãƒ¼ãƒ«ã®åˆ¶å¾¡ã‚’ç„¡åŠ¹åŒ–
                        ball.isControlled = false;

                        // é€Ÿåº¦ã®åè»¢ (è²«é€šå¼¾ã®å ´åˆã¯åè»¢ã—ãªã„)
                        if (!isPenetrating) {
                            const penetrationDepthX = ball.radius - Math.abs(distanceX);
                            const penetrationDepthY = ball.radius - Math.abs(distanceY);
    
                            if (penetrationDepthX > penetrationDepthY) {
                                ball.vy *= -1;
                            } else {
                                ball.vx *= -1;
                            }
                        }
                        
                        block.health--;
                        score += 10;
                        scoreElement.textContent = score;

                        if (block.health <= 0) {
                            blocks.splice(i, 1);
                        }
                        
                        if (blocks.length === 0) {
                            stageClearTimes[currentStage] = (Date.now() - gameStartTime) / 1000;
                            
                            if (currentStage < 3) {
                                currentStage++;
                                showQuiz(); 
                                return;
                            } else {
                                endGame(true);
                                return;
                            }
                        }
                        
                        break; 
                    }
                }

                // è¡çªãƒã‚§ãƒƒã‚¯ - ãƒ‘ãƒ‰ãƒ«ï¼ˆç™ºå°„å°ï¼‰
                if (ball.y + ball.radius > LAUNCH_POS_Y - currentPaddleWidth) { // ãƒ‘ãƒ‰ãƒ«ã®Yä½ç½®
                    const paddleLeft = paddleX - currentPaddleWidth;
                    const paddleRight = paddleX + currentPaddleWidth;

                    if (ball.x + ball.radius > paddleLeft && ball.x - ball.radius < paddleRight) {
                        // ãƒ‘ãƒ‰ãƒ«ä¸Šéƒ¨ã‹ã‚‰ã®è¡çª
                        if (ball.vy > 0 && ball.y + ball.radius < LAUNCH_POS_Y) {
                            ball.vy *= -1;
                            
                            // åå°„è§’ã‚’ãƒ‘ãƒ‰ãƒ«ã«å½“ãŸã£ãŸä½ç½®ã«å¿œã˜ã¦èª¿æ•´
                            const hitPoint = (ball.x - paddleX) / currentPaddleWidth;
                            ball.vx = hitPoint * 10; // å¤§ããå¤–å´ã§å½“ãŸã‚‹ã¨é€Ÿåº¦ãŒå¢—ã™

                            // ãƒ‘ãƒ‰ãƒ«ã«å½“ãŸã£ãŸã‚‰ãƒœãƒ¼ãƒ«åˆ¶å¾¡ã‚’å†æœ‰åŠ¹åŒ–
                            ball.isControlled = true;
                        }
                    }
                }
            });
            
            if (balls.length > 0 && balls.filter(b => b.isLaunched).length === 0) {
                endGame(false);
            }
        }
        
        function launchBall() {
            if (gameState !== 'PLAYING') return;
            
            // æœ€åˆã®ãƒœãƒ¼ãƒ«ã‚’ãƒ‘ãƒ‰ãƒ«ä¸­å¤®ã‹ã‚‰ç™ºå°„
            if (balls.length === 0) { 
                const newBall = new Ball(paddleX, LAUNCH_POS_Y, INITIAL_VELOCITY_Y * ballSpeedMultiplier);
                balls.push(newBall);
            }
        }
        
        // --- ã‚¯ã‚¤ã‚ºå±¥æ­´ç®¡ç†æ©Ÿèƒ½ (å¤‰æ›´ãªã—) ---
        function loadUsedQuizIndices() {
            const json = localStorage.getItem(USED_QUIZ_KEY);
            return json ? JSON.parse(json) : [];
        }

        function saveUsedQuizIndex(index) {
            let indices = loadUsedQuizIndices();
            if (!indices.includes(index)) {
                indices.push(index);
                if (indices.length > QUIZ_DATA.length - 1) { 
                    indices = []; 
                }
                localStorage.setItem(USED_QUIZ_KEY, JSON.stringify(indices));
            }
        }
        
        function showQuiz() {
            gameState = 'PAUSED_QUIZ';
            uiOverlay.style.display = 'flex';
            quizScreen.style.display = 'block';
            homeScreen.style.display = 'none'; 
            endScreen.style.display = 'none'; 
            quizResultMessageElement.style.display = 'none';
            continueButton.style.display = 'none';
            
            quizStageNumElement.textContent = currentStage;

            const usedIndices = loadUsedQuizIndices();
            const allIndices = QUIZ_DATA.map((_, index) => index);
            let availableIndices = allIndices.filter(index => !usedIndices.includes(index));

            if (availableIndices.length === 0) {
                localStorage.removeItem(USED_QUIZ_KEY);
                availableIndices = QUIZ_DATA.map((_, index) => index);
            }
            
            const quizIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            const currentQuiz = QUIZ_DATA[quizIndex];
            
            quizQuestionElement.textContent = availableIndices.length === QUIZ_DATA.length 
                ? `(å…¨å•ãƒªã‚»ãƒƒãƒˆ) ${currentQuiz.question}`
                : currentQuiz.question;
            
            setupQuizOptions(currentQuiz, quizIndex);
        }
        
        function setupQuizOptions(currentQuiz, quizIndex) {
            quizOptionsElement.innerHTML = '';
            currentQuiz.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option';
                button.textContent = option;
                button.onclick = () => checkQuiz(button.textContent, currentQuiz.answer, quizIndex);
                quizOptionsElement.appendChild(button);
            });
        }
        
        function checkQuiz(selectedAnswer, correctAnswer, quizIndex) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(btn => {
                btn.disabled = true; 
                if (btn.textContent === correctAnswer) {
                    btn.style.backgroundColor = '#39FF14'; 
                } else if (btn.textContent === selectedAnswer) {
                    btn.style.backgroundColor = '#FF3131'; 
                }
            });
            
            saveUsedQuizIndex(quizIndex); 

            if (selectedAnswer === correctAnswer) {
                applyQuizReward(true);
                quizResultMessageElement.textContent = "ğŸ‰ æ­£è§£ï¼ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆã¨è²«é€šå¼¾ã‚’ç²å¾—ï¼";
                quizResultMessageElement.className = "result-text correct";
            } else {
                applyQuizReward(false);
                quizResultMessageElement.textContent = "âŒ ä¸æ­£è§£... ãƒ‘ãƒ‰ãƒ«ãŒå°ã•ããªã‚Šã¾ã—ãŸã€‚";
                quizResultMessageElement.className = "result-text incorrect";
            }

            quizResultMessageElement.style.display = 'block';
            continueButton.style.display = 'block';
        }

        function applyQuizReward(isCorrect) {
            ballSpeedMultiplier = 1.0;
            isPenetrating = false;
            currentPaddleWidth = DEFAULT_PADDLE_WIDTH;

            if (isCorrect) {
                ballSpeedMultiplier = 1.3; 
                isPenetrating = true;
                
                setTimeout(() => {
                    ballSpeedMultiplier = 1.0;
                }, 10000); 
            } else {
                currentPaddleWidth = DEFAULT_PADDLE_WIDTH / 2; 

                setTimeout(() => {
                    currentPaddleWidth = DEFAULT_PADDLE_WIDTH;
                }, 10000);
            }
        }
        
        function continueGame() {
            quizScreen.style.display = 'none';
            uiOverlay.style.display = 'none';
            
            initializeBlocks(currentStage); 
            balls = [];
            stageNumElement.textContent = `${currentStage}/3`;
            paddleX = CANVAS_WIDTH / 2; // ãƒ‘ãƒ‰ãƒ«ã‚’ä¸­å¤®ã«æˆ»ã™

            gameState = 'PLAYING'; 
            
            clearInterval(launchTimer);
            // ğŸš€ ä¿®æ­£: launchBallã‚’ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‘¼ã³å‡ºã—ã€è‡ªå‹•ç™ºå°„ã¯ã•ã›ãªã„
            launchBall(); 
        }

        // --- UI / ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‡¦ç† (å¤‰æ›´ãªã—) ---
        const RANKING_KEY = 'BlockBlastRanking';

        function loadRanking() {
            const json = localStorage.getItem(RANKING_KEY);
            return json ? JSON.parse(json) : [];
        }

        function saveRanking(totalTime) {
            let rankings = loadRanking();
            rankings.push(totalTime);
            rankings.sort((a, b) => a - b); 
            rankings = rankings.slice(0, 10);
            localStorage.setItem(RANKING_KEY, JSON.stringify(rankings));
        }

        function displayRanking(listElement) {
            const rankings = loadRanking();
            listElement.innerHTML = '';
            
            if (rankings.length === 0) {
                listElement.innerHTML = '<li>No records yet.</li>';
                return;
            }

            rankings.forEach((time, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${index + 1}.</span> <span>${time.toFixed(2)}s</span>`;
                listElement.appendChild(li);
            });
        }
        
        // --- ğŸ† ãƒ›ãƒ¼ãƒ ç”»é¢æ©Ÿèƒ½ (å¤‰æ›´ãªã—) ---
        function showHome() {
            gameState = 'HOME';
            uiOverlay.style.display = 'flex';
            homeScreen.style.display = 'block';
            quizScreen.style.display = 'none';
            endScreen.style.display = 'none';
            
            clearInterval(launchTimer);

            displayRanking(homeRankingList);
        }

        function startGame() {
            score = 0;
            currentStage = 1;
            stageClearTimes = {};
            
            ballSpeedMultiplier = 1.0;
            isPenetrating = false;
            currentPaddleWidth = DEFAULT_PADDLE_WIDTH;
            paddleX = CANVAS_WIDTH / 2; // ä¸­å¤®ã‹ã‚‰é–‹å§‹

            homeScreen.style.display = 'none'; 

            gameStartTime = Date.now(); 
            scoreElement.textContent = score;

            showQuiz();

            if (!animationFrameId) {
                animate();
            }
        }

        function endGame(win = false) {
            clearInterval(launchTimer);
            
            let totalTime = 0;
            if (win) {
                for (let i = 1; i <= 3; i++) {
                    totalTime += stageClearTimes[i] || 0;
                }
                saveRanking(totalTime);
                endTitle.textContent = `ğŸš€ STAGE CLEAR! TOTAL TIME: ${totalTime.toFixed(2)}s`;
            } else {
                endTitle.textContent = `GAME OVER... SCORE: ${score} points`;
            }
            
            gameState = 'ENDED';
            displayRanking(rankingList); 
            
            quizScreen.style.display = 'none'; 
            endScreen.style.display = 'block'; 
            uiOverlay.style.display = 'flex';
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨åˆ¶å¾¡ ---
        let animationFrameId = null;

        function animate() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            if (gameState === 'PLAYING') {
                updatePaddlePosition(); // ğŸš€ ä¿®æ­£: ãƒ‘ãƒ‰ãƒ«ã‚’æ‰‹å‹•ã§å‹•ã‹ã™

                const elapsed = Date.now() - gameStartTime;
                timeDisplayElement.textContent = (elapsed / 1000).toFixed(2);
                
                // ç™ºå°„å°ï¼ˆãƒ‘ãƒ‰ãƒ«ï¼‰ã®æç”»
                ctx.fillStyle = '#9370DB'; 
                ctx.beginPath();
                ctx.arc(paddleX, LAUNCH_POS_Y, currentPaddleWidth, 0, Math.PI * 2); 
                ctx.fill();
                
                blocks.forEach(block => block.draw());
                balls.forEach(ball => {
                    if(ball.isLaunched) { 
                        ball.update();
                        ball.draw();
                    }
                });
                checkCollisions();
            }

            animationFrameId = requestAnimationFrame(animate);
        }
        
        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚­ãƒ¼æ“ä½œã‚’ãƒ‘ãƒ‰ãƒ«æ“ä½œã«å¤‰æ›´) ---
        document.getElementById('restart-button').addEventListener('click', showHome); 
        startGameButton.addEventListener('click', startGame);                       
        continueButton.addEventListener('click', continueGame);
        homeButton.addEventListener('click', showHome);                             

        // ğŸš€ ä¿®æ­£: å·¦å³ã‚­ãƒ¼ã‚’ãƒ‘ãƒ‰ãƒ«ã®ç§»å‹•ã«å‰²ã‚Šå½“ã¦ã‚‹
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                if (gameState === 'PLAYING') keys[e.code] = true;
                e.preventDefault(); 
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                if (gameState === 'PLAYING') keys[e.code] = false;
            }
        });

        showHome();
        animate(); 
    });
</script>
</body>
</html>
